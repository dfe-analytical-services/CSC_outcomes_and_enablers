<script>
// Define dataLayer and the gtag function.
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}

// Default ad_storage to 'denied' as a placeholder
// Determine actual values based on your own requirements
gtag('consent', 'default', {
  'ad_storage': 'denied',
  'analytics_storage': 'denied'
});
</script>

<!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Q13T4ENF6C"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}

    gtag('js', new Date());
    
/*
The tracking number below MUST be replaced with a unique number, contact the statistics development team to set this up. 
*/
  gtag('config', 'G-Q13T4ENF6C');
  
  
function getActivePage() {
  const activeNavLink = document.querySelector('ul#navlistPanel > li.nav-item > a.nav-link.active');
  return activeNavLink ? activeNavLink.getAttribute('data-value') : 'Unknown Page';
}

function getActiveTab() {
  const activeTabPane = document.querySelector('.tabbable .tab-pane.active.show');
  return activeTabPane ? activeTabPane.getAttribute('data-value') : 'Unknown Tab';
}

  // record disconnected events
  $(document).on('shiny:disconnected', function(e) {
    gtag('event', 'disconnect', { 
      'event_label' : 'Disconnect',
      'event_category' : 'Disconnect'
    });
  });

  // This handles tracking the top level choices menu via the active navlistPanel
  $(document).on('click', 'ul#navlistPanel', function(e) {
    gtag('event', 'navlistPanel', {'event_category' : 'navbar click',
    'event_label' : getActivePage()
    });
  });

  /* Adding in custom google analytics tracking for the domain tabs */
  $(document).on('click', 'ul.nav-tabs a', function(e) {
    gtag('event', 'Domain selection', {
      'event_category': getActivePage() + ' - Domain selection',
      'event_label': e.currentTarget.innerText.trim()
    });
  });

  // Adding in custom google analytics tracking for the Accordian selections
  $(document).on('click', '.accordion-button', function(e) {
    const button = e.currentTarget;
    const collapseId = button.getAttribute('data-bs-target') || button.getAttribute('aria-controls');
    const collapseEl = collapseId ? document.getElementById(collapseId.replace('#', '')) : null;
    // Only track if accordion is being **opened** (i.e., not already visible)
    if (collapseEl && !collapseEl.classList.contains('show')) {
      const label = button.innerText.trim();
      console.log('Active page: ' + getActivePage());
      console.log('Active domain: ' + getActiveTab());
      gtag('event', 'Accordion Opened', {
        event_category: getActivePage() + ' > ' + getActiveTab(),
        event_label: label
      });
    }
  });
  
  /*  Adding in custom google analytics tracking for the geographic  selections */
  $(document).on('change', 'select', function(e) {
      var selectedValue = $(this).val();
      var selectedId = $(this).attr("id");
      
      if (selectedId.startsWith("geographic_breakdown_")) {
          
          gtag(
            'event', 
            'Dropdown: Geo-select', 
          {
            'event_category' : getActivePage() + ' > ' + getActiveTab(), 
            'event_label' : selectedValue 
          });
      }
    });

  /*  Adding in custom google analytics tracking for the Non-geographic  selections */    
  $(document).on('change', 'select', function(e) {
      var selectedValue = $(this).val();
      var selectedId = $(this).attr("id");
      
      if (selectedId == "wellbeing_extra_breakdown" || 
          selectedId == "wellbeing_school_breakdown" || 
          selectedId == "attainment_extra_breakdown" ||
          selectedId == "assessment_factors_1" ||
          selectedId == "assessment_factors_2" ||
          selectedId == "placement_type_breakdown" ||
          selectedId == "select_age_group_o4" ||
          selectedId == "leavers_age") {
         
          gtag(
            'event', 
            'Dropdown: Non-geographic', 
          {
            'event_category' : getActivePage() + ' > ' + getActiveTab() + ' > ' + selectedId, 
            'event_label' : selectedValue
          });
        }
    });
  
</script>
      

